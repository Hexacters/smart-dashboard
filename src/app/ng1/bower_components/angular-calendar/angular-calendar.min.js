angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(d,h,f){var c=1,b=1,e=d.eventSources,g=d.calendarWatchEvent?d.calendarWatchEvent:angular.noop,a=function(i){var j;if(i){j=function(){var k=arguments;var l=this;h(function(){i.apply(l,k)})}}return j};this.eventsFingerprint=function(i){if(!i._id){i._id=b++}return""+i._id+(i.id||"")+(i.title||"")+(i.url||"")+(+i.start||"")+(+i.end||"")+(i.allDay||"")+(i.className||"")+g(i)||""};this.sourcesFingerprint=function(i){return i.__id||(i.__id=c++)};this.allEvents=function(){var j=[];for(var m=0,n=e.length;m<n;m++){var p=e[m];if(angular.isArray(p)){j.push(p)}else{if(angular.isObject(p)&&angular.isArray(p.events)){var k={};for(var l in p){if(l!=="_uiCalId"&&l!=="events"){k[l]=p[l]}}for(var o=0;o<p.events.length;o++){angular.extend(p.events[o],k)}j.push(p.events)}}}return Array.prototype.concat.apply([],j)};this.changeWatcher=function(i,l){var j;var m=function(){var u=angular.isFunction(i)?i():i;var p=[],r,s;for(var q=0,t=u.length;q<t;q++){s=u[q];r=l(s);n[r]=s;p.push(r)}return p};var k=function(r,q){var p=[],t={},s,u;for(s=0,u=q.length;s<u;s++){t[q[s]]=true}for(s=0,u=r.length;s<u;s++){if(!t[r[s]]){p.push(r[s])}}return p};var n={};var o=function(z,x){var u,r,q,s;var t={};var p=k(x,z);for(u=0,r=p.length;u<r;u++){var v=p[u];q=n[v];delete n[v];var w=l(q);if(w===v){j.onRemoved(q)}else{t[w]=v;j.onChanged(q)}}var y=k(z,x);for(u=0,r=y.length;u<r;u++){s=y[u];q=n[s];if(!t[s]){j.onAdded(q)}}};return j={subscribe:function(p,q){p.$watch(m,function(s,r){if(!q||q(s,r)!==false){o(s,r)}},true)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}};this.getFullCalendarConfig=function(j,k){var i={};angular.extend(i,k);angular.extend(i,j);angular.forEach(i,function(m,l){if(typeof m==="function"){i[l]=a(i[l])}});return i};this.getLocaleConfig=function(i){if(!i.lang||i.useNgLocale){var k=function(n){var m,l;m=[];for(l in n){m[l]=n[l]}return m};var j=f.DATETIME_FORMATS;return{monthNames:k(j.MONTH),monthNamesShort:k(j.SHORTMONTH),dayNames:k(j.DAY),dayNamesShort:k(j.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(a){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(k,f,i,e){var b=k.eventSources,d=false,c,h=e.changeWatcher(b,e.sourcesFingerprint),j=e.changeWatcher(e.allEvents,e.eventsFingerprint),l=null;function g(){var p=i.uiCalendar?k.$parent.$eval(i.uiCalendar):{},n;n=e.getFullCalendarConfig(p,a);var m=e.getLocaleConfig(n);angular.extend(m,n);l={eventSources:b};angular.extend(l,m);l.calendars=null;var r={};for(var q in l){if(q!=="eventSources"){r[q]=l[q]}}return JSON.stringify(r)}k.destroy=function(){if(c&&c.fullCalendar){c.fullCalendar("destroy")}if(i.calendar){c=a.calendars[i.calendar]=$(f).html("")}else{c=$(f).html("")}};k.init=function(){c.fullCalendar(l)};h.onAdded=function(m){c.fullCalendar("addEventSource",m);d=true};h.onRemoved=function(m){c.fullCalendar("removeEventSource",m);d=true};j.onAdded=function(m){c.fullCalendar("renderEvent",m)};j.onRemoved=function(m){c.fullCalendar("removeEvents",function(n){return n._id===m._id})};j.onChanged=function(m){m._start=$.fullCalendar.moment(m.start);m._end=$.fullCalendar.moment(m.end);c.fullCalendar("updateEvent",m)};h.subscribe(k);j.subscribe(k,function(n,m){if(d===true){d=false;return false}});k.$watch(g,function(n,m){k.destroy();k.init()})}}}]);